import org.apache.camel.ProducerTemplate;
import org.apache.camel.component.mock.MockEndpoint;
import org.apache.camel.test.spring.junit5.CamelSpringBootTest;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

@CamelSpringBootTest
@SpringBootTest
public class CreatePackageRouteSpringTest {

    @Autowired
    private ProducerTemplate template;

    @Autowired
    private org.apache.camel.CamelContext context;

    @Test
    public void testCreatePackage() throws Exception {
        MockEndpoint prepareRequest = context.getEndpoint("mock:direct:ru.seventech.esb.technoprom.prepareRequest.v2", MockEndpoint.class);
        MockEndpoint createPackage = context.getEndpoint("mock:https://{{url_createPackage_v2}}?httpClientConfigurer=trustAllHttpClientConfigurer", MockEndpoint.class);

        prepareRequest.expectedMessageCount(1);
        createPackage.expectedMessageCount(1);

        String body = """
            {
              "packageType": "SOME_TYPE",
              "packageData": {},
              "orgId": "ORG",
              "agentId": "AG"
            }
        """;

        template.sendBodyAndHeader("direct:ru.seventech.esb.technoprom.createPackage.v2", body, "Authorization", "Bearer test");

        prepareRequest.assertIsSatisfied();
        createPackage.assertIsSatisfied();
    }
}
