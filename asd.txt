<route id="timingLoggerRoute">
    <description>Reusable route for method execution timing (start + end)</description>
    <from uri="direct:startMethodTiming"/>
    
    <!-- Параметры -->
    <choice>
        <when>
            <simple>${exchangeProperty.methodName} == null</simple>
            <setProperty name="methodName">
                <simple>anonymous_method</simple>
            </setProperty>
        </when>
    </choice>

    <!-- 1. Инициализация таймера (первая часть) -->
    <setProperty name="methodStartTime">
        <simple>${date:now:yyyy-MM-dd HH:mm:ss.SSS}</simple>
    </setProperty>
    <setProperty name="methodStartTimestamp">
        <simple>${date:now:epoch}</simple>
    </setProperty>
    
    <!-- Передаем управление в основной маршрут -->
    <toD uri="direct:${exchangeProperty.targetRoute}"/>
    
    <!-- 2. Финализация таймера (вторая часть) -->
    <setProperty name="methodEndTime">
        <simple>${date:now:yyyy-MM-dd HH:mm:ss.SSS}</simple>
    </setProperty>
    <setProperty name="executionTimeMs">
        <groovy>
            (System.currentTimeMillis() - exchange.properties.methodStartTimestamp)
        </groovy>
    </setProperty>
    
    <!-- Логирование -->
    <log message="[TIMING] Method: ${exchangeProperty.methodName} | Duration: ${exchangeProperty.executionTimeMs} ms"
         loggingLevel="INFO"
         loggerRef="ru.seventech.esb.timing"/>
</route>
